<!DOCTYPE html>
<html>
  <head>
<style type="text/css">
  @import url(http://fonts.googleapis.com/css?family=Droid+Serif:400,700);
  body {
    font-family: "Droid Serif", serif;
    color: #444;
    line-height: 150%;
    border: 0px;
    margin: 0px;
    width: 100%;
    height: 100%;
    overflow: hidden !important;
  }
  video {
    width: 100%;
    height: 100%;
    margin: auto auto;
    overflow: hidden !important;
  }
</style>
<!--
Include the Receiver Library - Very important use our URL, don't attempt to
host this yourself.
-->
<script type="text/javascript"
    src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js">
</script>
    <title>Narwhal TV</title>
  </head>
  <body>Narwhal TV
    <video id='vid' />
<script type="text/javascript">
window.addEventListener('load', function() {
  //Add youtube element
  console.log("Setting up youtube player");
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  //Start receiving events
  console.log('Application is ready, starting system');
  window.castReceiverManager.start();

});


//CHROMECAST LOGIC
var narwhalMessageNamespace="urn:x-cast:org.elsewhat.narwhal"

// Turn on debugging so that you can see what is going on.  Please turn this off
// on your production receivers to improve performance.
cast.receiver.logger.setLevelValue(cast.receiver.LoggerLevel.DEBUG);

// Start the receiver SDK.

window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();

window.messageBus = window.castReceiverManager.getCastMessageBus(narwhalMessageNamespace);

window.messageBus.onMessage = function(event) {
    console.log("### Message Bus - Message: " + JSON.stringify(event));
    try{
      var msgData =  JSON.parse(event.data);
      var videoId= msgData.data.videoId;
      console.log("About to play video with id "+ videoId);

      player.loadVideoById(videoId,0,"highres");

    } catch (ex){
      console.log("Got exception on parsing event.data "+event.data);
    } 
  
}


castReceiverManager.onSenderDisconnected = function (event) {
  console.log("sender disconnected");
  if(window.castReceiverManager.getSenders().length == 0 &&
    event.reason == cast.receiver.system.DisconnectReason.REQUESTED_BY_SENDER) {
      window.close();
  }
};

window.castReceiverManager.onSenderConnected = function(event) {
    console.log("### Cast Receiver Manager - Sender Connected : " + JSON.stringify(event));

    var senders = window.castReceiverManager.getSenders();
    console.log("session count "+ senders.length);
};


//YOUTUBE LOGIC
function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
      height: 562,
      width: 1000,
      playerVars: { 
          'autoplay': 0, 
          'controls': 0 },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
}

function onPlayerReady() {
  //channel.send({'event':'iframeApiReady','message':'ready'});
}

function onPlayerStateChange(event) {
  //channel.send({'event':'stateChange','message':event.data});
  //if (event.data==YT.PlayerState.ENDED) {
  //  endcast();
  //}
}


</script>
  </body>
</html>